<!-- MESMO HTML/CSS anterior, s√≥ mude o SCRIPT -->
<script>
// === MESMO FIREBASE ===
firebase.initializeApp({
  apiKey: "AIzaSyCovHcUFKP9dtwRxfnajhvGUgluCFp0HVQ",
  authDomain: "liga4x4volei-71358.firebaseapp.com",
  projectId: "liga4x4volei-71358"
});
const db = firebase.firestore();
const REF = db.collection("ofertasHorario");

const SENHA_CORRETA = "liga123";
const TIMES = ["Time 1","Time 2","Time 3","Time 4","Time 5","Time 6","Time 7","Time 8","Time 9","Time 10","Time 11","Time 12"];

// Login (igual)
function entrar(){
  const senha = document.getElementById('senhaInput').value;
  if(senha !== SENHA_CORRETA){
    alert("‚ùå Senha errada! (liga123)");
    return;
  }
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appMain').style.display='block';
  document.getElementById('meuTime').innerHTML = '<option value="">Escolha seu time</option>' + 
    TIMES.map(t=>`<option value="${t}">${t}</option>`).join('');
  carregarOfertas(); // CHAMADA CORRIGIDA
}

// === CARREGAMENTO CORRIGIDO ===
async function carregarOfertas(){
  console.log("üîÑ Carregando ofertas...");
  const lista = document.getElementById('listaOfertas');
  lista.innerHTML = '<div style="text-align:center;padding:20px;">üîÑ Carregando...<br>Total: 0</div>';
  
  try {
    // TENTA CARREGAR (com timeout)
    const snap = await Promise.race([
      REF.orderBy("dataCriacao", "desc").get(),
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error("Timeout")), 10000)
      )
    ]);
    
    console.log(`üìä ${snap.size} ofertas encontradas`);
    
    if(snap.empty){
      lista.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.7;">üì≠ Nenhuma oferta. Fa√ßa a primeira!</div>';
      return;
    }
    
    let html = '';
    let total = 0;
    
    snap.forEach(doc => {
      const o = doc.data();
      total++;
      const dataFmt = new Date(o.data).toLocaleDateString('pt-BR');
      const statusClass = o.status === 'confirmado' ? 'status-confirmado' : 'status-disponivel';
      const statusText = o.status === 'confirmado' ? '‚úÖ Confirmado' : '‚è≥ Dispon√≠vel';
      
      html += `
        <div class="oferta">
          <div class="oferta-header">
            <h3>${o.quadra} ‚Äì ${o.hora}</h3>
            <span class="status ${statusClass}">${statusText}</span>
          </div>
          <div class="oferta-detalhes">
            üìÖ ${dataFmt}<br>
            üèê ${o.timeOfertante} ${o.aceitoPor ? `x <strong>${o.aceitoPor}</strong>` : '(aguardando)'}
          </div>
          ${!o.aceitoPor ? `
            <div style="margin-top:15px;">
              <button class="btn btn-primary" onclick="aceitarOferta('${doc.id}', '${o.timeOfertante}')">
                ‚úÖ ACEITO
              </button>
            </div>
          ` : ''}
        </div>
      `;
    });
    
    lista.innerHTML = `
      <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:15px;">
        Total: <strong>${total}</strong> oferta${total>1?'s':''}
      </div>
      ${html}
    `;
    
  } catch(error) {
    console.error("‚ùå Erro:", error);
    lista.innerHTML = '<div style="text-align:center;padding:30px;color:#ff6b6b;">‚ùå Erro de conex√£o. Tente novamente.</div>';
  }
}

// Cria oferta (com confirma√ß√£o)
async function criarOferta(e){
  e.preventDefault();
  
  const timeOfertante = document.getElementById('meuTime').value;
  if(!timeOfertante){
    alert("Escolha seu time!");
    return;
  }
  
  const dados = {
    timeOfertante,
    quadra: document.getElementById('quadra').value,
    data: document.getElementById('data').value,
    hora: document.getElementById('hora').value,
    status: "disponivel",
    aceitoPor: null,
    dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  try {
    await REF.add(dados);
    alert("‚úÖ Oferta criada e salva no Firebase!");
    e.target.reset();
    setTimeout(carregarOfertas, 1000); // Aguarda 1s pra sincronizar
  } catch(error) {
    console.error("Erro ao criar:", error);
    alert("‚ùå Erro ao salvar. Verifique conex√£o.");
  }
}

// Aceitar (com valida√ß√£o)
async function aceitarOferta(id, timeOfertante){
  const meuTime = document.getElementById('meuTime').value;
  if(!meuTime){
    alert("üëÜ Escolha seu time primeiro!");
    return;
  }
  if(meuTime === timeOfertante){
    alert("N√£o pode aceitar oferta do pr√≥prio time!");
    return;
  }
  
  if(confirm(`‚úÖ Confirmar jogo?\n${timeOfertante} x ${meuTime}`)){
    try {
      await REF.doc(id).update({
        status: "confirmado",
        aceitoPor: meuTime,
        dataAceite: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("üéâ Jogo marcado!");
      carregarOfertas();
    } catch(error) {
      console.error("Erro ao aceitar:", error);
      alert("‚ùå Erro ao confirmar.");
    }
  }
}
</script>
