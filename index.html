<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèê Liga 4x4 - Agendamentos</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https: *.google.com *.gstatic.com *.firebaseio.com *.firebaseapp.com *.googleapis.com *.googleusercontent.com *.firebase.google.com;">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial;}
body{background:linear-gradient(90deg,#004aad 0%,#0d99ff 100%);min-height:100vh;padding:20px;color:#fff;}
.container{max-width:650px;margin:0 auto;background:rgba(255,255,255,0.1);border-radius:20px;padding:25px;box-shadow:0 20px 40px rgba(0,0,0,0.3);backdrop-filter:blur(15px);}
.login-form{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;justify-content:center;align-items:center;flex-direction:column;}
.login-form input{width:300px;max-width:90vw;padding:15px;border-radius:12px;border:none;font-size:18px;margin-bottom:15px;background:rgba(255,255,255,0.9);}
.login-btn{width:300px;max-width:90vw;padding:15px 20px;border:none;border-radius:12px;background:linear-gradient(135deg,#28a745,#20c997);color:#fff;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(40,167,69,0.4);}
.login-btn:hover{transform:translateY(-2px);}
.admin-badge{background:#ffc107;color:#000;padding:4px 8px;border-radius:20px;font-size:12px;font-weight:bold;}
h1,h2{text-align:center;font-weight:800;}
h1{font-size:28px;margin-bottom:10px;}
h2{font-size:20px;margin:30px 0 15px;color:rgba(255,255,255,0.9);}
.form-row{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;margin-bottom:12px;}
label{display:block;font-size:14px;font-weight:600;margin-bottom:4px;}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.9);font-size:16px;}
.btn{padding:10px 20px;border:none;border-radius:999px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,0.3);transition:.3s;font-size:14px;}
.btn-primary{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;}
.btn-login{background:linear-gradient(135deg,#ffc107,#ff8f00);color:#000;}
.btn-cancelar{background:#dc3545;color:#fff;}
.btn:hover{transform:translateY(-2px);}
.ofertas{max-height:60vh;overflow-y:auto;}
.oferta{background:rgba(255,255,255,0.1);border-radius:16px;padding:20px;margin-bottom:15px;box-shadow:0 10px 25px rgba(0,0,0,0.2);border-left:5px solid #ff6b6b;}
.oferta-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.oferta-header h3{margin:0;font-size:20px;}
.status{padding:6px 12px;border-radius:20px;font-size:14px;font-weight:700;}
.status-disponivel{background:rgba(255,193,7,0.3);color:#ffc107;}
.status-confirmado{background:rgba(40,167,69,0.3);color:#28a745;}
.oferta-detalhes{font-size:14px;opacity:0.9;}
.public-notice{background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;}
.btn-group{display:flex;gap:8px;flex-wrap:wrap;}
@media(max-width:500px){.form-row{grid-template-columns:1fr;}.oferta-header{flex-direction:column;gap:8px;text-align:center;}.btn-group{flex-direction:column;width:100%;}}
</style>
</head>
<body>
<div id="appMain" class="container">
  <h1>üèê Liga 4x4 - Agendamentos</h1>
  
  <div class="public-notice">
    <strong>üëÄ P√∫blico:</strong> Veja todas as ofertas<br>
    <strong>üîê Privado:</strong> 
    <button class="btn btn-login" onclick="mostrarLogin()" style="font-size:14px;padding:8px 16px;margin-top:5px;">üîë AGENDAR</button>
    <div style="font-size:12px;opacity:0.8;margin-top:5px;">Senha = nome do time (min√∫sculo)</div>
  </div>

  <h2>‚è∞ Todas as ofertas</h2>
  <div id="listaOfertas" class="ofertas">
    <div style="text-align:center;padding:30px;opacity:0.7;">üîÑ Carregando ofertas...</div>
  </div>

  <!-- FORM AGENDAR (escondido at√© senha) -->
  <div id="formAgendar" style="display:none;">
    <div id="adminBadge" class="admin-badge" style="display:none;">üëë MODO ADMIN</div>
    <h2 style="margin-top:10px;">üì¢ Ofere√ßa um hor√°rio</h2>
    <form onsubmit="criarOferta(event)">
      <div class="form-row">
        <div>
          <label>Seu time <span style="color:#ff6b6b;">*</span></label>
          <select id="meuTime" required>
            <option value="">Carregando times...</option>
          </select>
        </div>
        <div>
          <label>Quadra <span style="color:#ff6b6b;">*</span></label>
          <select id="quadra" required>
            <option value="">Escolha quadra</option>
            <option value="Arena Bel√©m">Arena Bel√©m</option>
            <option value="Arena Meteoro">Arena Meteoro</option>
            <option value="Mega Sports">Mega Sports</option>
            <option value="Praia Bel√©m">Praia Bel√©m</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div><label>Data <span style="color:#ff6b6b;">*</span></label><input id="data" type="date" required></div>
        <div><label>Hora <span style="color:#ff6b6b;">*</span></label><input id="hora" type="time" required></div>
        <button type="submit" class="btn btn-primary">üöÄ OFERECER</button>
      </div>
    </form>
  </div>
</div>

<!-- LOGIN POPUP -->
<div id="loginScreen" class="login-form" style="display:none;">
  <h1 style="margin-bottom:20px;">üîê Autentica√ß√£o</h1>
  <p style="margin-bottom:20px;font-size:18px;">Senha do time (min√∫scula) ou <strong>liga4x4</strong> (admin)</p>
  <input type="password" id="senhaInput" placeholder="ex: watchatchara" maxlength="20" style="margin-bottom:20px;">
  <button class="login-btn" onclick="entrar()">‚úÖ ENTRAR</button>
  <br><button class="btn btn-login" onclick="mostrarLogin()" style="margin-top:15px;width:auto;">‚ùå Cancelar</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyCovHcUFKP9dtwRxfnajhvGUgluCFp0HVQ",
  authDomain: "liga4x4volei-71358.firebaseapp.com",
  projectId: "liga4x4volei-71358"
});
const db = firebase.firestore();
const REF = db.collection("ofertasHorario");

// üîê SENHAS POR TIME (min√∫sculas)
const SENHAS_TIMES = {
  "liga4x4": "ADMIN_COMPLETO",  // Admin faz tudo
  "watchatchara": "Watchatchara",
  "time1": "Time 1",
  "time2": "Time 2",
  "time3": "Time 3", 
  "time4": "Time 4",
  "time5": "Time 5",
  "time6": "Time 6",
  "time7": "Time 7",
  "time8": "Time 8",
  "time9": "Time 9",
  "time10": "Time 10",
  "time11": "Time 11",
  "time12": "Time 12"
};

let usuarioAtual = null;  // {senha, timesPermitidos, isAdmin}

function mostrarLogin(){
  document.getElementById('loginScreen').style.display = 'flex';
}

function entrar(){
  const senha = document.getElementById('senhaInput').value.toLowerCase().trim();
  const infoUsuario = SENHAS_TIMES[senha];
  
  if(!infoUsuario){
    alert("‚ùå Senha inv√°lida!\nDica: nome do time em min√∫sculas ou 'liga4x4'");
    return;
  }
  
  usuarioAtual = {
    senha: senha,
    timesPermitidos: infoUsuario === "ADMIN_COMPLETO" ? Object.values(SENHAS_TIMES).filter(t => typeof t === "string") : [infoUsuario],
    isAdmin: infoUsuario === "ADMIN_COMPLETO"
  };
  
  // Mostra badge admin
  if(usuarioAtual.isAdmin){
    document.getElementById('adminBadge').style.display = 'inline-block';
  }
  
  // Preenche select com times permitidos
  const select = document.getElementById('meuTime');
  select.innerHTML = '<option value="">Escolha seu time</option>';
  usuarioAtual.timesPermitidos.forEach(time => {
    select.innerHTML += `<option value="${time}">${time}</option>`;
  });
  
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('formAgendar').style.display = 'block';
  alert(`‚úÖ Bem-vindo(a), ${usuarioAtual.isAdmin ? 'ADMIN' : usuarioAtual.timesPermitidos[0]}!`);
}

async function carregarOfertas(){
  const lista = document.getElementById('listaOfertas');
  lista.innerHTML = '<div style="text-align:center;padding:20px;">üîÑ Carregando...</div>';
  
  try {
    const snap = await REF.orderBy("dataCriacao", "desc").get();
    if(snap.empty){
      lista.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.7;">üì≠ Nenhuma oferta ainda. <button class="btn btn-login" onclick="mostrarLogin()" style="font-size:12px;padding:6px 12px;">Ofere√ßa a primeira!</button></div>';
      return;
    }
    
    let html = `<div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:15px;">Total: <strong>${snap.size}</strong> oferta${snap.size > 1 ? 's' : ''}</div>`;
    
    snap.forEach(doc => {
      const o = doc.data();
      const dataFmt = new Date(o.data).toLocaleDateString('pt-BR');
      const statusClass = o.status === 'confirmado' ? 'status-confirmado' : 'status-disponivel';
      const statusText = o.status === 'confirmado' ? '‚úÖ Confirmado' : '‚è≥ Dispon√≠vel';
      
      // S√≥ times logados podem aceitar/cancelar/excluir
      // ACEITAR dispon√≠vel para TODOS (com lista fixa de times)
let botoes = '';
if(!o.aceitoPor){
  botoes += `
    <div class="btn-group">
      <select id="aceitarTime_${doc.id}" style="flex:1;min-width:120px;">
        <option value="">Escolha time</option>
        <option value="Watchatchara">Watchatchara</option>
        <option value="Time 1">Time 1</option>
        <option value="Time 2">Time 2</option>
        <option value="Time 3">Time 3</option>
        <option value="Time 4">Time 4</option>
        <option value="Time 5">Time 5</option>
        <option value="Time 6">Time 6</option>
        <option value="Time 7">Time 7</option>
        <option value="Time 8">Time 8</option>
        <option value="Time 9">Time 9</option>
        <option value="Time 10">Time 10</option>
        <option value="Time 11">Time 11</option>
        <option value="Time 12">Time 12</option>
      </select>
      <button class="btn btn-primary" onclick="aceitarOferta('${doc.id}', '${o.timeOfertante}')">‚úÖ ACEITO</button>
    </div>`;
}

        botoes += `
          <div class="btn-group">
            <select id="aceitarTime_${doc.id}" style="flex:1;min-width:120px;">
              <option value="">Escolha time</option>
              ${usuarioAtual.timesPermitidos.map(t => `<option value="${t}">${t}</option>`).join('')}
            </select>
            <button class="btn btn-primary" onclick="aceitarOferta('${doc.id}', '${o.timeOfertante}')">‚úÖ ACEITO</button>
          </div>`;
      }
      
      // CANCELAR (quem ofereceu OU admin)
      if(usuarioAtual && !o.aceitoPor && (usuarioAtual.isAdmin || usuarioAtual.timesPermitidos.includes(o.timeOfertante))){
        botoes += `<button class="btn btn-cancelar" onclick="cancelarOferta('${doc.id}')" style="width:100%;margin-top:8px;">‚ùå CANCELAR</button>`;
      }
      
      // EXCLUIR CONFIRMADO (s√≥ admin)
      if(usuarioAtual && o.aceitoPor && usuarioAtual.isAdmin){
        botoes += `<button class="btn btn-cancelar" onclick="excluirConfirmado('${doc.id}')" style="width:100%;margin-top:8px;">üóëÔ∏è EXCLUIR JOGO</button>`;
      }
      
      html += `
        <div class="oferta">
          <div class="oferta-header">
            <h3>${o.quadra} ‚Äì ${o.hora}</h3>
            <span class="status ${statusClass}">${statusText}</span>
          </div>
          <div class="oferta-detalhes">
            üìÖ ${dataFmt}<br>
            üèê ${o.timeOfertante} ${o.aceitoPor ? `x <strong>${o.aceitoPor}</strong>` : '(aguardando)'}
          </div>
          ${botoes ? `<div style="margin-top:15px;">${botoes}</div>` : ''}
        </div>`;
    });
    lista.innerHTML = html;
  } catch(error) {
    lista.innerHTML = '<div style="text-align:center;padding:30px;color:#ff6b6b;">‚ùå Erro de conex√£o.</div>';
  }
}

async function criarOferta(e){
  e.preventDefault();
  if(!usuarioAtual){
    alert("‚ùå Fa√ßa login primeiro!");
    mostrarLogin();
    return;
  }
  
  const timeOfertante = document.getElementById('meuTime').value;
  if(!timeOfertante){
    alert("‚ùå Escolha seu time!");
    return;
  }
  
  const dados = {
    timeOfertante,
    quadra: document.getElementById('quadra').value,
    data: document.getElementById('data').value,
    hora: document.getElementById('hora').value,
    status: "disponivel",
    aceitoPor: null,
    dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  try {
    await REF.add(dados);
    alert("‚úÖ Oferta criada!");
    e.target.reset();
    carregarOfertas();
  } catch(error) {
    alert("‚ùå Erro ao salvar.");
  }
}

async function aceitarOferta(id, timeOfertante){
  const meuTime = document.getElementById(`aceitarTime_${id}`).value;
  if(!meuTime || meuTime === timeOfertante){
    alert("‚ùå Escolha time diferente!");
    return;
  }
  
  if(confirm(`‚úÖ Confirmar?\n${timeOfertante} x ${meuTime}`)){
    try {
      await REF.doc(id).update({
        status: "confirmado",
        aceitoPor: meuTime,
        dataAceite: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("üéâ Jogo confirmado!");
      carregarOfertas();
    } catch(error) {
      alert("‚ùå Erro ao confirmar.");
    }
  }
}

async function cancelarOferta(id){
  if(confirm("‚ùå Cancelar oferta?")){
    try {
      await REF.doc(id).delete();
      alert("‚úÖ Cancelada!");
      carregarOfertas();
    } catch(error) {
      alert("‚ùå Erro ao cancelar.");
    }
  }
}

async function excluirConfirmado(id){
  if(confirm("üóëÔ∏è EXCLUIR JOGO CONFIRMADO?\nN√£o pode desfazer!")){
    try {
      await REF.doc(id).delete();
      alert("‚úÖ Jogo exclu√≠do!");
      carregarOfertas();
    } catch(error) {
      alert("‚ùå Erro ao excluir.");
    }
  }
}

// ‚úÖ INICIALIZA
carregarOfertas();
</script>
</body>
</html>
