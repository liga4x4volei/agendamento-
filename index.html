<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèê Liga 4x4 - Agendamentos</title>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https: *.google.com *.gstatic.com *.firebaseio.com *.firebaseapp.com *.googleapis.com *.googleusercontent.com;">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",Arial,sans-serif;}
body{
  background:linear-gradient(120deg,#004aad 0%,#0d99ff 100%);
  color:#fff;
  min-height:100vh;
  padding:20px;
}
.container{
  max-width:700px;margin:0 auto;background:rgba(255,255,255,0.1);
  border-radius:20px;padding:25px;
  box-shadow:0 20px 40px rgba(0,0,0,0.3);
  backdrop-filter:blur(15px);
}
h1{text-align:center;margin-bottom:10px;}
h2{margin:20px 0 10px;text-align:center;}
.ofertas{max-height:65vh;overflow-y:auto;}
.oferta{background:rgba(255,255,255,0.1);border-radius:16px;padding:15px;margin-bottom:15px;}
.oferta-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;}
.status{padding:4px 10px;border-radius:20px;font-size:13px;font-weight:bold;}
.status-disponivel{background:rgba(255,193,7,0.3);color:#ffc107;}
.status-confirmado{background:rgba(40,167,69,0.3);color:#28a745;}
.btn{border:none;border-radius:999px;padding:10px 18px;font-weight:bold;cursor:pointer;transition:.2s;}
.btn:hover{transform:translateY(-2px);}
.btn-primary{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;}
.btn-cancelar{background:#dc3545;color:#fff;}
select,input{padding:10px;border:none;border-radius:12px;width:100%;margin:4px 0;}
/* Bot√£o flutuante unificado */
#btnNovaOferta{
  position:fixed;bottom:25px;right:25px;
  width:60px;height:60px;border-radius:50%;
  background:linear-gradient(135deg,#00c6ff,#0072ff);
  color:#fff;font-size:32px;font-weight:bold;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 20px rgba(0,0,0,0.3);
  cursor:pointer;z-index:1000;
}
#btnNovaOferta:hover{transform:scale(1.05);}
.login-modal,.form-modal,.admin-modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.85);
  display:none;justify-content:center;align-items:center;z-index:9999;
}
.modal-content{
  background:rgba(255,255,255,0.1);
  padding:25px;border-radius:20px;
  width:90%;max-width:380px;text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}
.modal-content input, .modal-content select{
  background:rgba(255,255,255,0.9);
  margin-bottom:12px;
}
.modal-content button{margin-top:8px;width:100%;}
.admin-panel{max-height:70vh;overflow-y:auto;text-align:left;}
@media(max-width:500px){
  .oferta-header{flex-direction:column;align-items:flex-start;}
}
</style>
</head>
<body>
<div class="container">
  <h1>üèê Liga 4x4 - Agendamentos</h1>
  <p style="text-align:center;opacity:0.9;">Veja e aceite ofertas de jogos ‚Äî publique hor√°rios dispon√≠veis!</p>
  <div class="ofertas" id="listaOfertas">
    <div style="text-align:center;padding:25px;opacity:0.7;">üîÑ Carregando ofertas...</div>
  </div>
</div>

<!-- Bot√£o flutuante -->
<div id="btnNovaOferta">+</div>

<!-- Modal Login -->
<div class="login-modal" id="loginModal">
  <div class="modal-content">
    <h2>üîê Entrar</h2>
    <p>Digite a senha do time ou <strong>liga4x4</strong> (admin)</p>
    <input type="password" id="senhaInput" placeholder="ex: voleitche" maxlength="30">
    <button class="btn btn-primary" onclick="entrar()">Entrar</button>
    <button class="btn btn-cancelar" onclick="fecharLogin()">Cancelar</button>
  </div>
</div>

<!-- Modal Nova Oferta -->
<div class="form-modal" id="ofertaModal">
  <div class="modal-content">
    <h2>üìÖ Nova Oferta</h2>
    <select id="meuTime" required></select>
    <select id="quadra" required>
      <option value="">Escolha quadra</option>
      <option value="Arena Bel√©m">Arena Bel√©m</option>
      <option value="Arena Meteoro">Arena Meteoro</option>
      <option value="Mega Sports">Mega Sports</option>
      <option value="Praia Bel√©m">Praia Bel√©m</option>
    </select>
    <input id="data" type="date" required>
    <input id="hora" type="time" required>
    <button class="btn btn-primary" onclick="criarOferta()">üöÄ Publicar</button>
    <button class="btn btn-cancelar" onclick="fecharOferta()">Cancelar</button>
  </div>
</div>

<!-- Modal Admin -->
<div class="admin-modal" id="adminModal">
  <div class="modal-content admin-panel">
    <h2>üëë Painel Admin</h2>
    <div id="adminLista"></div>
    <button class="btn btn-cancelar" onclick="fecharAdmin()">Fechar</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyCovHcUFKP9dtwRxfnajhvGUgluCFp0HVQ",
  authDomain: "liga4x4volei-71358.firebaseapp.com",
  projectId: "liga4x4volei-71358"
});
const db = firebase.firestore();
const REF = db.collection("ofertasHorario");

const SENHAS = {
  "liga4x4":"ADMIN_COMPLETO",
  "watchatchara":"Watchatchara",
  "iron":"Iron",
  "matrix":"Matrix",
  "filhosdafenix":"Filhos da F√™nix",
  "summer":"Summer",
  "hungers":"Hungers",
  "voleitche":"V√¥lei Tche",
  "conflitus":"Conflitus",
  "baroesdalargadinha":"Bar√µes da Largadinha",
  "falcoes":"Falc√µes",
  "time11":"Time 11",
  "time12":"Time 12"
};

let usuarioAtual=null;

document.getElementById('btnNovaOferta').onclick=()=>{mostrarLogin();};

function mostrarLogin(){document.getElementById('loginModal').style.display='flex';document.getElementById('senhaInput').focus();}
function fecharLogin(){document.getElementById('loginModal').style.display='none';document.getElementById('senhaInput').value='';}
function fecharOferta(){document.getElementById('ofertaModal').style.display='none';}
function fecharAdmin(){document.getElementById('adminModal').style.display='none';}

function entrar(){
  const senha=document.getElementById('senhaInput').value.trim().toLowerCase();
  if(!senha)return;
  if(senha==='liga4x4'){
    usuarioAtual={isAdmin:true,nome:'Admin'};
    fecharLogin();
    abrirAdmin();
    return;
  }
  if(SENHAS[senha]){
    usuarioAtual={isAdmin:false,nome:SENHAS[senha]};
    const sel=document.getElementById('meuTime');
    sel.innerHTML=`<option value="${usuarioAtual.nome}">${usuarioAtual.nome}</option>`;
    fecharLogin();
    document.getElementById('ofertaModal').style.display='flex';
  }else{
    alert('‚ùå Senha inv√°lida!');
  }
}

async function carregarOfertas(){
  const lista=document.getElementById('listaOfertas');
  lista.innerHTML='<div style="text-align:center;padding:20px;">üîÑ Carregando...</div>';
  const snap=await REF.orderBy('dataCriacao','desc').get();
  let html='';
  if(snap.empty){
    lista.innerHTML='<div style="text-align:center;opacity:0.7;padding:20px;">üì≠ Nenhuma oferta no momento.</div>';
    return;
  }
  const agora=new Date();
  for(const doc of snap.docs){
    const o=doc.data();
    // limpeza autom√°tica ap√≥s 3 dias de jogos confirmados
    if(o.status==='confirmado' && new Date(o.data)<agora.setDate(agora.getDate()-3)){
      await REF.doc(doc.id).delete();
      continue;
    }
    const dataFmt=new Date(o.data).toLocaleDateString('pt-BR');
    const statusClass=o.status==='confirmado'?'status-confirmado':'status-disponivel';
    const statusText=o.status==='confirmado'?'‚úÖ Confirmado':'‚è≥ Dispon√≠vel';
    html+=`
    <div class="oferta">
      <div class="oferta-header">
        <h3>${o.quadra} - ${o.hora}</h3>
        <span class="status ${statusClass}">${statusText}</span>
      </div>
      <div>üìÖ ${dataFmt}<br>üèê ${o.timeOfertante} ${o.aceitoPor?`x <strong>${o.aceitoPor}</strong>`:'(aguardando)'}</div>
      ${!o.aceitoPor?`<div style="margin-top:10px;">
        <select id="aceitarTime_${doc.id}">
          <option value="">Escolha time</option>
          ${Object.values(SENHAS).filter(v=>v!=='ADMIN_COMPLETO').map(t=>`<option>${t}</option>`).join('')}
        </select>
        <button class="btn btn-primary" onclick="aceitarOferta('${doc.id}','${o.timeOfertante}')">‚úÖ Aceitar</button>
      </div>`:''}
    </div>`;
  }
  lista.innerHTML=html;
}

async function criarOferta(){
  const time=document.getElementById('meuTime').value;
  const quadra=document.getElementById('quadra').value;
  const data=document.getElementById('data').value;
  const hora=document.getElementById('hora').value;
  if(!time||!quadra||!data||!hora){alert('‚ùå Preencha tudo!');return;}
  await REF.add({
    timeOfertante:time,quadra,data,hora,
    status:'disponivel',aceitoPor:null,
    dataCriacao:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('‚úÖ Oferta criada!');
  fecharOferta();
  carregarOfertas();
}

async function aceitarOferta(id,timeOfertante){
  const sel=document.getElementById(`aceitarTime_${id}`);
  const time=sel.value;
  if(!time||time===timeOfertante){alert('‚ùå Escolha um time v√°lido!');return;}
  if(confirm(`Confirmar jogo ${timeOfertante} x ${time}?`)){
    await REF.doc(id).update({
      status:'confirmado',
      aceitoPor:time,
      dataAceite:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('üéâ Jogo confirmado!');
    carregarOfertas();
  }
}

async function abrirAdmin(){
  const snap=await REF.get();
  let html='';
  snap.forEach(doc=>{
    const o=doc.data();
    html+=`<div style="border-bottom:1px solid rgba(255,255,255,0.2);padding:8px 0;">
      <strong>${o.timeOfertante}</strong> - ${o.quadra} ${o.data} ${o.hora} (${o.status})
      <br><button class="btn btn-cancelar" style="margin-top:5px;" onclick="excluir('${doc.id}')">üóëÔ∏è Excluir</button>
    </div>`;
  });
  document.getElementById('adminLista').innerHTML=html||'Nenhuma oferta.';
  document.getElementById('adminModal').style.display='flex';
}
async function excluir(id){
  if(confirm('Excluir este registro?')){
    await REF.doc(id).delete();
    alert('‚úÖ Exclu√≠do!');
    abrirAdmin();
    carregarOfertas();
  }
}
carregarOfertas();
</script>
</body>
</html>
